name: Decision Deposit Placer

on:
  # Run on a schedule (every 4 hours)
  schedule:
    - cron: '0 */4 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      place_deposits:
        description: 'Set to true to place deposits, false to just scan'
        required: true
        default: 'false'
      networks:
        description: 'Networks to process (comma-separated, e.g., polkadot,kusama)'
        required: true
        default: 'polkadot,kusama'
      track_ids:
        description: 'Track IDs to monitor (comma-separated, e.g., 30,32)'
        required: true
        default: '30'

jobs:
  run-depositor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          # Networks to process
          NETWORKS=${{ github.event.inputs.networks || 'polkadot,kusama' }}

          # Account seed (from secrets)
          ACCOUNT_SEED=${{ secrets.ACCOUNT_SEED }}
          SS58_ADDRESS=${{ secrets.SS58_ADDRESS }}

          # Track IDs to monitor
          TRACK_IDS=${{ github.event.inputs.track_ids || '30' }}

          # Whether to place deposits
          PLACE_DEPOSITS=${{ github.event.inputs.place_deposits || secrets.DEFAULT_PLACE_DEPOSITS || 'false' }}

          # RPC Endpoints
          POLKADOT_RPC_ENDPOINT=${{ secrets.POLKADOT_RPC_ENDPOINT || 'wss://rpc.polkadot.io' }}
          KUSAMA_RPC_ENDPOINT=${{ secrets.KUSAMA_RPC_ENDPOINT || 'wss://kusama-rpc.polkadot.io' }}
          EOF
      
      - name: Run decision depositor
        run: node decision-depositor.js
      
      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: execution-logs
          path: |
            logs/
            *.log
          retention-days: 7